<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Generator - Daten visualisieren in Minuten</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel für JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart-Bibliothek -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- CSV-Parser -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Excel-Reader -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p>Dashboard wird geladen...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // Icons als einfache SVGs
        const UploadIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const BarChartIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );

        const LineIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 12l3-3 3 3 4-4" />
            </svg>
        );

        const CircleIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
            </svg>
        );

        const DashboardGenerator = () => {
            const [data, setData] = useState([]);
            const [originalData, setOriginalData] = useState([]);
            const [columns, setColumns] = useState([]);
            const [numericColumns, setNumericColumns] = useState([]);
            const [dateColumns, setDateColumns] = useState([]);
            const [fileName, setFileName] = useState('');
            const [loading, setLoading] = useState(false);
            
            // Chart-Einstellungen
            const [chartType, setChartType] = useState('bar');
            const [xAxis, setXAxis] = useState('');
            const [yAxis, setYAxis] = useState('');
            
            // UI-Zustand
            const [activeTab, setActiveTab] = useState('upload');

            const colors = ['#8884d8', '#82ca9d', '#ffc658', '#ff7300', '#00ff00', '#ff00ff'];

            // Datentypen automatisch erkennen
            const analyzeColumns = (data) => {
                if (!data.length) return { numeric: [], date: [], all: [] };
                
                const sample = data.slice(0, 50);
                const allCols = Object.keys(sample[0] || {});
                const numCols = [];
                const dateCols = [];
                
                allCols.forEach(col => {
                    const values = sample.map(row => row[col]).filter(v => v !== null && v !== undefined && v !== '');
                    
                    // Numeric check
                    const numericCount = values.filter(v => !isNaN(Number(v)) && v !== '').length;
                    if (numericCount > values.length * 0.7) {
                        numCols.push(col);
                    }
                    
                    // Date check
                    const dateCount = values.filter(v => {
                        const date = new Date(v);
                        return date instanceof Date && !isNaN(date);
                    }).length;
                    if (dateCount > values.length * 0.7) {
                        dateCols.push(col);
                    }
                });
                
                return { numeric: numCols, date: dateCols, all: allCols };
            };

            // Datei verarbeiten
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setLoading(true);
                setFileName(file.name);
                
                try {
                    let parsedData = [];
                    
                    if (file.name.endsWith('.csv')) {
                        const text = await file.text();
                        const result = Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            delimitersToGuess: [',', '\t', '|', ';']
                        });
                        parsedData = result.data;
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        const arrayBuffer = await file.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { cellDates: true });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        parsedData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    // Spalten bereinigen
                    parsedData = parsedData.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const cleanKey = key.trim();
                            cleanRow[cleanKey] = row[key];
                        });
                        return cleanRow;
                    });
                    
                    const columnAnalysis = analyzeColumns(parsedData);
                    
                    setOriginalData(parsedData);
                    setData(parsedData);
                    setColumns(columnAnalysis.all);
                    setNumericColumns(columnAnalysis.numeric);
                    setDateColumns(columnAnalysis.date);
                    
                    // Auto-select defaults
                    if (columnAnalysis.all.length > 0) {
                        setXAxis(columnAnalysis.date[0] || columnAnalysis.all[0]);
                        setYAxis(columnAnalysis.numeric[0] || columnAnalysis.all[1] || columnAnalysis.all[0]);
                    }
                    
                    setActiveTab('dashboard');
                } catch (error) {
                    alert('Fehler beim Laden der Datei: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            // Daten für Charts vorbereiten
            const chartData = useMemo(() => {
                if (!data.length || !xAxis || !yAxis) return [];
                
                const grouped = data.reduce((acc, row) => {
                    const key = String(row[xAxis]);
                    if (!acc[key]) {
                        acc[key] = { [xAxis]: row[xAxis], [yAxis]: 0, count: 0 };
                    }
                    acc[key][yAxis] += Number(row[yAxis]) || 0;
                    acc[key].count += 1;
                    return acc;
                }, {});
                
                return Object.values(grouped).slice(0, 15);
            }, [data, xAxis, yAxis]);

            // Chart rendern
            const renderChart = () => {
                if (!chartData.length) {
                    return (
                        <div className="flex items-center justify-center h-64 text-gray-500">
                            <p>Keine Daten zum Anzeigen verfügbar</p>
                        </div>
                    );
                }

                switch (chartType) {
                    case 'line':
                        return (
                            <ResponsiveContainer width="100%" height={400}>
                                <LineChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey={xAxis} />
                                    <YAxis />
                                    <Tooltip />
                                    <Legend />
                                    <Line type="monotone" dataKey={yAxis} stroke="#8884d8" strokeWidth={2} />
                                </LineChart>
                            </ResponsiveContainer>
                        );
                    
                    case 'pie':
                        return (
                            <ResponsiveContainer width="100%" height={400}>
                                <PieChart>
                                    <Pie
                                        data={chartData.slice(0, 8)}
                                        cx="50%"
                                        cy="50%"
                                        outerRadius={120}
                                        fill="#8884d8"
                                        dataKey={yAxis}
                                        nameKey={xAxis}
                                        label={({ name, value }) => `${name}: ${value}`}
                                    >
                                        {chartData.slice(0, 8).map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={colors[index % colors.length]} />
                                        ))}
                                    </Pie>
                                    <Tooltip />
                                    <Legend />
                                </PieChart>
                            </ResponsiveContainer>
                        );
                    
                    default:
                        return (
                            <ResponsiveContainer width="100%" height={400}>
                                <BarChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey={xAxis} />
                                    <YAxis />
                                    <Tooltip />
                                    <Legend />
                                    <Bar dataKey={yAxis} fill="#8884d8" />
                                </BarChart>
                            </ResponsiveContainer>
                        );
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div className="container mx-auto p-4 max-w-6xl">
                        {/* Header */}
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                                📊 Dashboard Generator
                            </h1>
                            <p className="text-gray-600">
                                Excel- und CSV-Dateien in interaktive Dashboards verwandeln - in Sekunden!
                            </p>
                        </div>

                        {/* Navigation */}
                        <div className="bg-white rounded-xl shadow-lg mb-6">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('upload')}
                                    className={`px-6 py-3 font-medium flex items-center gap-2 ${activeTab === 'upload' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}
                                >
                                    <UploadIcon />
                                    Datei hochladen
                                </button>
                                <button
                                    onClick={() => setActiveTab('dashboard')}
                                    className={`px-6 py-3 font-medium flex items-center gap-2 ${activeTab === 'dashboard' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}
                                    disabled={!data.length}
                                >
                                    <BarChartIcon />
                                    Dashboard
                                </button>
                            </div>
                        </div>

                        {/* Upload Tab */}
                        {activeTab === 'upload' && (
                            <div className="bg-white rounded-xl shadow-lg p-8">
                                <div className="text-center">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 mb-4 hover:border-blue-400 transition-colors">
                                        <div className="flex justify-center mb-4">
                                            <UploadIcon />
                                        </div>
                                        <label htmlFor="file-upload" className="cursor-pointer">
                                            <span className="text-xl font-medium text-blue-600 hover:text-blue-500">
                                                Datei auswählen
                                            </span>
                                            <p className="text-gray-500 mt-2">oder hier hineinziehen</p>
                                            <p className="text-sm text-gray-400 mt-2">CSV, Excel (.xlsx, .xls) - bis 50MB</p>
                                        </label>
                                        <input
                                            id="file-upload"
                                            type="file"
                                            className="hidden"
                                            accept=".csv,.xlsx,.xls"
                                            onChange={handleFileUpload}
                                        />
                                    </div>
                                    
                                    {loading && (
                                        <div className="flex items-center justify-center gap-2 text-blue-600">
                                            <div className="loading w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                                            Datei wird analysiert...
                                        </div>
                                    )}
                                    
                                    {fileName && (
                                        <p className="text-sm text-green-600 mt-2 flex items-center justify-center gap-2">
                                            ✅ Datei erfolgreich geladen: <span className="font-medium">{fileName}</span>
                                        </p>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && data.length > 0 && (
                            <div className="space-y-6">
                                {/* Datenübersicht */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4">📊 Ihre Daten</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                                            <p className="text-sm text-gray-600">Zeilen</p>
                                            <p className="text-2xl font-bold text-blue-600">{data.length.toLocaleString()}</p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <p className="text-sm text-gray-600">Spalten</p>
                                            <p className="text-2xl font-bold text-green-600">{columns.length}</p>
                                        </div>
                                        <div className="bg-purple-50 p-4 rounded-lg text-center">
                                            <p className="text-sm text-gray-600">Zahlen-Spalten</p>
                                            <p className="text-2xl font-bold text-purple-600">{numericColumns.length}</p>
                                        </div>
                                        <div className="bg-orange-50 p-4 rounded-lg text-center">
                                            <p className="text-sm text-gray-600">Datei</p>
                                            <p className="text-lg font-bold text-orange-600">{fileName.split('.').pop().toUpperCase()}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Chart-Einstellungen */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4">🎛️ Chart-Einstellungen</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        {/* Chart-Typ */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Diagramm-Typ</label>
                                            <div className="flex gap-1">
                                                <button
                                                    onClick={() => setChartType('bar')}
                                                    className={`p-3 rounded flex-1 flex items-center justify-center ${chartType === 'bar' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                                    title="Balkendiagramm"
                                                >
                                                    <BarChartIcon />
                                                </button>
                                                <button
                                                    onClick={() => setChartType('line')}
                                                    className={`p-3 rounded flex-1 flex items-center justify-center ${chartType === 'line' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                                    title="Liniendiagramm"
                                                >
                                                    <LineIcon />
                                                </button>
                                                <button
                                                    onClick={() => setChartType('pie')}
                                                    className={`p-3 rounded flex-1 flex items-center justify-center ${chartType === 'pie' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                                    title="Kreisdiagramm"
                                                >
                                                    <CircleIcon />
                                                </button>
                                            </div>
                                        </div>

                                        {/* X-Achse */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">X-Achse (Kategorien)</label>
                                            <select 
                                                value={xAxis} 
                                                onChange={(e) => setXAxis(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                                {columns.map(col => (
                                                    <option key={col} value={col}>{col}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Y-Achse */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Y-Achse (Werte)</label>
                                            <select 
                                                value={yAxis} 
                                                onChange={(e) => setYAxis(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                                {numericColumns.length > 0 ? numericColumns.map(col => (
                                                    <option key={col} value={col}>{col}</option>
                                                )) : columns.map(col => (
                                                    <option key={col} value={col}>{col}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Aktionen */}
                                        <div className="flex items-end">
                                            <button
                                                onClick={() => setActiveTab('upload')}
                                                className="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors"
                                            >
                                                Neue Datei
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Chart */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold">
                                            📈 {yAxis} nach {xAxis}
                                        </h2>
                                        <div className="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                                            {chartData.length} Datenpunkte
                                        </div>
                                    </div>
                                    
                                    <div className="h-96 w-full">
                                        {renderChart()}
                                    </div>
                                </div>

                                {/* Datenvorschau */}
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h3 className="text-lg font-semibold mb-4">🔍 Datenvorschau (erste 5 Zeilen)</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm border-collapse">
                                            <thead>
                                                <tr className="bg-gray-50">
                                                    {columns.slice(0, 6).map(col => (
                                                        <th key={col} className="px-4 py-3 text-left font-medium text-gray-600 border-b border-gray-200">
                                                            {col}
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.slice(0, 5).map((row, index) => (
                                                    <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                                                        {columns.slice(0, 6).map(col => (
                                                            <td key={col} className="px-4 py-3 text-gray-800">
                                                                {String(row[col] || '').slice(0, 30)}
                                                                {String(row[col] || '').length > 30 && '...'}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    {columns.length > 6 && (
                                        <p className="text-sm text-gray-500 mt-2">
                                            ... und {columns.length - 6} weitere Spalten
                                        </p>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Footer */}
                        <div className="text-center mt-8 p-6 bg-white rounded-xl shadow-lg">
                            <p className="text-gray-600 mb-2">
                                🚀 <strong>Dashboard Generator</strong> - Ihre Daten, professionell visualisiert
                            </p>
                            <p className="text-sm text-gray-500">
                                Keine Installation • Funktioniert in jedem Browser • Ihre Daten bleiben privat
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // App rendern
        ReactDOM.render(<DashboardGenerator />, document.getElementById('root'));
    </script>
</body>
</html>
