<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Generator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/esm/index.js" type="module"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        import React, { useState, useEffect, useMemo } from 'react';
        import { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
        import { Upload, BarChart3, TrendingUp, Circle, Filter, Download, Eye, Settings } from 'lucide-react';
        import Papa from 'papaparse';
        import * as XLSX from 'xlsx';
        
        const DashboardGenerator = () => {
          const [data, setData] = useState([]);
          const [originalData, setOriginalData] = useState([]);
          const [columns, setColumns] = useState([]);
          const [numericColumns, setNumericColumns] = useState([]);
          const [dateColumns, setDateColumns] = useState([]);
          const [fileName, setFileName] = useState('');
          const [loading, setLoading] = useState(false);
          
          // Chart-Einstellungen
          const [chartType, setChartType] = useState('bar');
          const [xAxis, setXAxis] = useState('');
          const [yAxis, setYAxis] = useState('');
          const [groupBy, setGroupBy] = useState('');
          
          // Filter
          const [filters, setFilters] = useState({});
          const [dateRange, setDateRange] = useState({ start: '', end: '' });
          
          // UI-Zustand
          const [activeTab, setActiveTab] = useState('upload');
          const [showFilters, setShowFilters] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
        
          const colors = ['#8884d8', '#82ca9d', '#ffc658', '#ff7300', '#00ff00', '#ff00ff', '#00ffff', '#ff0000'];
        
          // Datentypen automatisch erkennen
          const analyzeColumns = (data) => {
            if (!data.length) return { numeric: [], date: [], all: [] };
            
            const sample = data.slice(0, 100); // Sample für Performance
            const allCols = Object.keys(sample[0] || {});
            const numCols = [];
            const dateCols = [];
            
            allCols.forEach(col => {
              const values = sample.map(row => row[col]).filter(v => v !== null && v !== undefined && v !== '');
              
              // Numeric check
              const numericCount = values.filter(v => !isNaN(Number(v)) && v !== '').length;
              if (numericCount > values.length * 0.7) {
                numCols.push(col);
              }
              
              // Date check
              const dateCount = values.filter(v => {
                const date = new Date(v);
                return date instanceof Date && !isNaN(date);
              }).length;
              if (dateCount > values.length * 0.7) {
                dateCols.push(col);
              }
            });
            
            return { numeric: numCols, date: dateCols, all: allCols };
          };
        
          // Datei verarbeiten
          const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
        
            setLoading(true);
            setFileName(file.name);
            
            try {
              let parsedData = [];
              
              if (file.name.endsWith('.csv')) {
                // CSV mit PapaParse
                const text = await file.text();
                const result = Papa.parse(text, {
                  header: true,
                  dynamicTyping: true,
                  skipEmptyLines: true,
                  delimitersToGuess: [',', '\t', '|', ';']
                });
                parsedData = result.data;
              } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                // Excel mit SheetJS
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { cellDates: true, cellNF: true });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                parsedData = XLSX.utils.sheet_to_json(firstSheet, { defval: null });
              }
              
              // Spalten-Header bereinigen
              parsedData = parsedData.map(row => {
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                  const cleanKey = key.trim();
                  cleanRow[cleanKey] = row[key];
                });
                return cleanRow;
              });
              
              const columnAnalysis = analyzeColumns(parsedData);
              
              setOriginalData(parsedData);
              setData(parsedData);
              setColumns(columnAnalysis.all);
              setNumericColumns(columnAnalysis.numeric);
              setDateColumns(columnAnalysis.date);
              
              // Auto-select sinnvolle Default-Werte
              if (columnAnalysis.all.length > 0) {
                setXAxis(columnAnalysis.date[0] || columnAnalysis.all[0]);
                setYAxis(columnAnalysis.numeric[0] || columnAnalysis.all[1] || columnAnalysis.all[0]);
              }
              
              setActiveTab('analyze');
            } catch (error) {
              alert('Fehler beim Laden der Datei: ' + error.message);
            } finally {
              setLoading(false);
            }
          };
        
          // Daten aggregieren für Charts
          const aggregatedData = useMemo(() => {
            if (!data.length || !xAxis || !yAxis) return [];
            
            let processedData = [...data];
            
            // Filter anwenden
            Object.entries(filters).forEach(([column, value]) => {
              if (value && value !== 'alle') {
                processedData = processedData.filter(row => String(row[column]).includes(value));
              }
            });
            
            // Datumsbereich-Filter
            if (dateRange.start && dateRange.end && dateColumns.includes(xAxis)) {
              processedData = processedData.filter(row => {
                const date = new Date(row[xAxis]);
                return date >= new Date(dateRange.start) && date <= new Date(dateRange.end);
              });
            }
            
            // Gruppierung und Aggregation
            if (groupBy && groupBy !== xAxis) {
              const grouped = processedData.reduce((acc, row) => {
                const key = `${row[xAxis]}_${row[groupBy]}`;
                if (!acc[key]) {
                  acc[key] = { [xAxis]: row[xAxis], [groupBy]: row[groupBy], [yAxis]: 0, count: 0 };
                }
                acc[key][yAxis] += Number(row[yAxis]) || 0;
                acc[key].count += 1;
                return acc;
              }, {});
              
              return Object.values(grouped);
            } else {
              // Einfache Aggregation nach X-Achse
              const grouped = processedData.reduce((acc, row) => {
                const key = String(row[xAxis]);
                if (!acc[key]) {
                  acc[key] = { [xAxis]: row[xAxis], [yAxis]: 0, count: 0 };
                }
                acc[key][yAxis] += Number(row[yAxis]) || 0;
                acc[key].count += 1;
                return acc;
              }, {});
              
              return Object.values(grouped).slice(0, 20); // Limit für Performance
            }
          }, [data, xAxis, yAxis, groupBy, filters, dateRange, dateColumns]);
        
          // Filter-Optionen generieren
          const getFilterOptions = (column) => {
            const uniqueValues = [...new Set(originalData.map(row => String(row[column])))];
            return uniqueValues.slice(0, 50); // Limit für Performance
          };
        
          // Chart rendern
          const renderChart = () => {
            if (!aggregatedData.length) {
              return (
                <div className="flex items-center justify-center h-64 text-gray-500">
                  <p>Keine Daten zum Anzeigen verfügbar</p>
                </div>
              );
            }
        
            const chartProps = {
              width: '100%',
              height: 400,
              data: aggregatedData,
              margin: { top: 20, right: 30, left: 20, bottom: 5 }
            };
        
            switch (chartType) {
              case 'line':
                return (
                  <ResponsiveContainer {...chartProps}>
                    <LineChart data={aggregatedData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey={xAxis} />
                      <YAxis />
                      <Tooltip />
                      <Legend />
                      <Line type="monotone" dataKey={yAxis} stroke="#8884d8" strokeWidth={2} />
                    </LineChart>
                  </ResponsiveContainer>
                );
              
              case 'pie':
                return (
                  <ResponsiveContainer {...chartProps}>
                    <PieChart>
                      <Pie
                        data={aggregatedData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                        outerRadius={120}
                        fill="#8884d8"
                        dataKey={yAxis}
                        nameKey={xAxis}
                      >
                        {aggregatedData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={colors[index % colors.length]} />
                        ))}
                      </Pie>
                      <Tooltip />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                );
              
              default: // bar
                return (
                  <ResponsiveContainer {...chartProps}>
                    <BarChart data={aggregatedData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey={xAxis} />
                      <YAxis />
                      <Tooltip />
                      <Legend />
                      <Bar dataKey={yAxis} fill="#8884d8" />
                    </BarChart>
                  </ResponsiveContainer>
                );
            }
          };
        
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              <div className="container mx-auto p-6">
                {/* Header */}
                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                  <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                    📊 Daten-Dashboard Generator
                  </h1>
                  <p className="text-gray-600">
                    Lade Excel- oder CSV-Dateien hoch und erstelle automatisch interaktive Dashboards
                  </p>
                </div>
        
                {/* Navigation */}
                <div className="bg-white rounded-xl shadow-lg mb-6">
                  <div className="flex border-b">
                    <button
                      onClick={() => setActiveTab('upload')}
                      className={`px-6 py-3 font-medium ${activeTab === 'upload' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}
                    >
                      <Upload className="w-4 h-4 inline mr-2" />
                      Datei hochladen
                    </button>
                    <button
                      onClick={() => setActiveTab('analyze')}
                      className={`px-6 py-3 font-medium ${activeTab === 'analyze' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}
                      disabled={!data.length}
                    >
                      <Eye className="w-4 h-4 inline mr-2" />
                      Daten analysieren
                    </button>
                    <button
                      onClick={() => setActiveTab('dashboard')}
                      className={`px-6 py-3 font-medium ${activeTab === 'dashboard' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600 hover:text-blue-600'}`}
                      disabled={!data.length}
                    >
                      <BarChart3 className="w-4 h-4 inline mr-2" />
                      Dashboard
                    </button>
                  </div>
                </div>
        
                {/* Content */}
                {activeTab === 'upload' && (
                  <div className="bg-white rounded-xl shadow-lg p-8">
                    <div className="text-center">
                      <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 mb-4">
                        <Upload className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                        <label htmlFor="file-upload" className="cursor-pointer">
                          <span className="text-lg font-medium text-blue-600 hover:text-blue-500">
                            Datei auswählen
                          </span>
                          <p className="text-gray-500 mt-2">oder Datei hier hineinziehen</p>
                          <p className="text-sm text-gray-400 mt-2">Unterstützt: CSV, Excel (.xlsx, .xls)</p>
                        </label>
                        <input
                          id="file-upload"
                          type="file"
                          className="hidden"
                          accept=".csv,.xlsx,.xls"
                          onChange={handleFileUpload}
                        />
                      </div>
                      
                      {loading && (
                        <div className="flex items-center justify-center gap-2 text-blue-600">
                          <div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                          Datei wird verarbeitet...
                        </div>
                      )}
                      
                      {fileName && (
                        <p className="text-sm text-gray-600 mt-2">
                          ✅ Datei geladen: <span className="font-medium">{fileName}</span>
                        </p>
                      )}
                    </div>
                  </div>
                )}
        
                {activeTab === 'analyze' && data.length > 0 && (
                  <div className="space-y-6">
                    {/* Daten-Übersicht */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h2 className="text-xl font-bold mb-4">📊 Datenübersicht</h2>
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded-lg">
                          <p className="text-sm text-gray-600">Zeilen</p>
                          <p className="text-2xl font-bold text-blue-600">{data.length.toLocaleString()}</p>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                          <p className="text-sm text-gray-600">Spalten</p>
                          <p className="text-2xl font-bold text-green-600">{columns.length}</p>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-lg">
                          <p className="text-sm text-gray-600">Numerische Spalten</p>
                          <p className="text-2xl font-bold text-purple-600">{numericColumns.length}</p>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-lg">
                          <p className="text-sm text-gray-600">Datums-Spalten</p>
                          <p className="text-2xl font-bold text-orange-600">{dateColumns.length}</p>
                        </div>
                      </div>
                      
                      {/* Spalten-Info */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                          <h3 className="font-semibold mb-2 text-blue-600">📊 Numerische Spalten</h3>
                          <div className="space-y-1">
                            {numericColumns.map(col => (
                              <span key={col} className="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2 mb-2">
                                {col}
                              </span>
                            ))}
                          </div>
                        </div>
                        <div>
                          <h3 className="font-semibold mb-2 text-orange-600">📅 Datums-Spalten</h3>
                          <div className="space-y-1">
                            {dateColumns.map(col => (
                              <span key={col} className="inline-block bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm mr-2 mb-2">
                                {col}
                              </span>
                            ))}
                          </div>
                        </div>
                        <div>
                          <h3 className="font-semibold mb-2 text-gray-600">📝 Alle Spalten</h3>
                          <div className="space-y-1">
                            {columns.slice(0, 10).map(col => (
                              <span key={col} className="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm mr-2 mb-2">
                                {col}
                              </span>
                            ))}
                            {columns.length > 10 && (
                              <span className="text-gray-500 text-sm">... und {columns.length - 10} weitere</span>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
        
                    {/* Datenvorschau */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h3 className="text-lg font-semibold mb-4">🔍 Datenvorschau (erste 5 Zeilen)</h3>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-gray-50">
                              {columns.slice(0, 8).map(col => (
                                <th key={col} className="px-3 py-2 text-left font-medium text-gray-600 border-b">
                                  {col}
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {data.slice(0, 5).map((row, index) => (
                              <tr key={index} className="border-b hover:bg-gray-50">
                                {columns.slice(0, 8).map(col => (
                                  <td key={col} className="px-3 py-2 text-gray-800">
                                    {String(row[col] || '').slice(0, 50)}
                                    {String(row[col] || '').length > 50 && '...'}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}
        
                {activeTab === 'dashboard' && data.length > 0 && (
                  <div className="space-y-6">
                    {/* Chart-Einstellungen */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold">⚙️ Diagramm-Einstellungen</h2>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setShowFilters(!showFilters)}
                            className={`px-3 py-1 rounded text-sm ${showFilters ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} hover:opacity-80`}
                          >
                            <Filter className="w-4 h-4 inline mr-1" />
                            Filter
                          </button>
                          <button
                            onClick={() => setShowSettings(!showSettings)}
                            className={`px-3 py-1 rounded text-sm ${showSettings ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} hover:opacity-80`}
                          >
                            <Settings className="w-4 h-4 inline mr-1" />
                            Erweitert
                          </button>
                        </div>
                      </div>
        
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        {/* Diagramm-Typ */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Diagramm-Typ</label>
                          <div className="flex gap-2">
                            <button
                              onClick={() => setChartType('bar')}
                              className={`p-2 rounded ${chartType === 'bar' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                              title="Balkendiagramm"
                            >
                              <BarChart3 className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => setChartType('line')}
                              className={`p-2 rounded ${chartType === 'line' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                              title="Liniendiagramm"
                            >
                              <TrendingUp className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => setChartType('pie')}
                              className={`p-2 rounded ${chartType === 'pie' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                              title="Kreisdiagramm"
                            >
                              <Circle className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
        
                        {/* X-Achse */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">X-Achse</label>
                          <select 
                            value={xAxis} 
                            onChange={(e) => setXAxis(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-md text-sm"
                          >
                            {columns.map(col => (
                              <option key={col} value={col}>{col}</option>
                            ))}
                          </select>
                        </div>
        
                        {/* Y-Achse */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Y-Achse</label>
                          <select 
                            value={yAxis} 
                            onChange={(e) => setYAxis(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-md text-sm"
                          >
                            {numericColumns.map(col => (
                              <option key={col} value={col}>{col}</option>
                            ))}
                          </select>
                        </div>
        
                        {/* Gruppierung */}
                        {showSettings && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Gruppierung (optional)</label>
                            <select 
                              value={groupBy} 
                              onChange={(e) => setGroupBy(e.target.value)}
                              className="w-full p-2 border border-gray-300 rounded-md text-sm"
                            >
                              <option value="">Keine</option>
                              {columns.filter(col => col !== xAxis && col !== yAxis).map(col => (
                                <option key={col} value={col}>{col}</option>
                              ))}
                            </select>
                          </div>
                        )}
                      </div>
        
                      {/* Filter */}
                      {showFilters && (
                        <div className="border-t pt-4">
                          <h3 className="font-semibold mb-3">🔍 Filter</h3>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* Datumsbereich für Datums-Spalten */}
                            {dateColumns.includes(xAxis) && (
                              <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Datumsbereich</label>
                                <div className="flex gap-2">
                                  <input
                                    type="date"
                                    value={dateRange.start}
                                    onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                                    className="flex-1 p-2 border border-gray-300 rounded-md text-sm"
                                  />
                                  <input
                                    type="date"
                                    value={dateRange.end}
                                    onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                                    className="flex-1 p-2 border border-gray-300 rounded-md text-sm"
                                  />
                                </div>
                              </div>
                            )}
        
                            {/* Kategorien-Filter */}
                            {columns.filter(col => !numericColumns.includes(col) && !dateColumns.includes(col)).slice(0, 3).map(col => (
                              <div key={col}>
                                <label className="block text-sm font-medium text-gray-700 mb-2">{col}</label>
                                <select 
                                  value={filters[col] || ''} 
                                  onChange={(e) => setFilters({...filters, [col]: e.target.value})}
                                  className="w-full p-2 border border-gray-300 rounded-md text-sm"
                                >
                                  <option value="">Alle</option>
                                  {getFilterOptions(col).slice(0, 20).map(option => (
                                    <option key={option} value={option}>{option}</option>
                                  ))}
                                </select>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
        
                    {/* Chart */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold">
                          📊 {yAxis} nach {xAxis}
                          {groupBy && ` (gruppiert nach ${groupBy})`}
                        </h2>
                        <div className="text-sm text-gray-600">
                          {aggregatedData.length} Datenpunkte
                        </div>
                      </div>
                      
                      <div className="h-96">
                        {renderChart()}
                      </div>
                    </div>
        
                    {/* Zusammenfassung */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h3 className="text-lg font-semibold mb-4">📋 Schnellstatistiken</h3>
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        {numericColumns.slice(0, 4).map(col => {
                          const values = data.map(row => Number(row[col])).filter(v => !isNaN(v));
                          const sum = values.reduce((a, b) => a + b, 0);
                          const avg = sum / values.length;
                          const max = Math.max(...values);
                          const min = Math.min(...values);
                          
                          return (
                            <div key={col} className="bg-gray-50 p-4 rounded-lg">
                              <h4 className="font-medium text-gray-800 mb-2">{col}</h4>
                              <div className="space-y-1 text-sm">
                                <p><span className="text-gray-600">Summe:</span> <span className="font-medium">{sum.toLocaleString()}</span></p>
                                <p><span className="text-gray-600">Durchschnitt:</span> <span className="font-medium">{avg.toFixed(2)}</span></p>
                                <p><span className="text-gray-600">Max:</span> <span className="font-medium">{max.toLocaleString()}</span></p>
                                <p><span className="text-gray-600">Min:</span> <span className="font-medium">{min.toLocaleString()}</span></p>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };
        
        export default DashboardGenerator;
    </script>
</body>
</html>
