<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Generator - Excel & CSV visualisieren</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js - Zuverl√§ssigere Chart-Bibliothek -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse f√ºr CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- SheetJS f√ºr Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .loading { 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            @apply bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-all duration-200 transform hover:scale-105;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors;
        }
        .card {
            @apply bg-white rounded-xl shadow-lg p-6 fade-in;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <div class="container mx-auto px-4 py-6">
        <div class="card mb-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-3">
                    üìä Dashboard Generator
                </h1>
                <p class="text-lg text-gray-600 mb-4">
                    Verwandeln Sie Excel- und CSV-Dateien in professionelle Dashboards
                </p>
                <p class="text-sm text-blue-600 font-medium">
                    ‚úÖ Keine Installation ‚Ä¢ ‚úÖ L√§uft in jedem Browser ‚Ä¢ ‚úÖ Ihre Daten bleiben privat
                </p>
            </div>
        </div>

        <!-- Upload Bereich -->
        <div id="uploadSection" class="card mb-6">
            <div class="text-center">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 hover:border-blue-400 transition-colors cursor-pointer" 
                     onclick="document.getElementById('fileInput').click()">
                    
                    <!-- Upload Icon -->
                    <div class="mb-4">
                        <svg class="w-16 h-16 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Datei ausw√§hlen</h3>
                    <p class="text-gray-500 mb-2">Klicken oder Datei hier hineinziehen</p>
                    <p class="text-sm text-gray-400">Unterst√ºtzt: CSV, Excel (.xlsx, .xls)</p>
                    
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                </div>

                <!-- Loading -->
                <div id="loadingDiv" class="hidden mt-4">
                    <div class="flex items-center justify-center gap-3">
                        <div class="loading w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                        <span class="text-blue-600 font-medium">Datei wird analysiert...</span>
                    </div>
                </div>

                <!-- Success -->
                <div id="successDiv" class="hidden mt-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-center gap-2 text-green-700">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">Datei erfolgreich geladen!</span>
                        </div>
                        <p id="fileInfo" class="text-sm text-green-600 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Bereich -->
        <div id="dashboardSection" class="hidden">
            <!-- Statistiken -->
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üìä Daten√ºbersicht</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="statsGrid">
                    <!-- Stats werden hier eingef√ºgt -->
                </div>
            </div>

            <!-- Chart-Einstellungen -->
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üéõÔ∏è Diagramm erstellen</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Chart-Typ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Diagramm-Typ</label>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="setChartType('bar')" id="btnBar" class="btn-secondary flex items-center justify-center p-3">
                                üìä
                            </button>
                            <button onclick="setChartType('line')" id="btnLine" class="btn-secondary flex items-center justify-center p-3">
                                üìà
                            </button>
                            <button onclick="setChartType('pie')" id="btnPie" class="btn-secondary flex items-center justify-center p-3">
                                ü•ß
                            </button>
                        </div>
                    </div>

                    <!-- X-Achse -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">X-Achse (Kategorien)</label>
                        <select id="xAxisSelect" onchange="updateChart()" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <!-- Optionen werden hier eingef√ºgt -->
                        </select>
                    </div>

                    <!-- Y-Achse -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Y-Achse (Werte)</label>
                        <select id="yAxisSelect" onchange="updateChart()" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <!-- Optionen werden hier eingef√ºgt -->
                        </select>
                    </div>

                    <!-- Aktionen -->
                    <div class="flex items-end">
                        <button onclick="resetApp()" class="w-full btn-secondary">
                            üîÑ Neue Datei
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="card mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold" id="chartTitle">üìà Ihr Dashboard</h2>
                    <span id="dataPointsCount" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium"></span>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <canvas id="myChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Datenvorschau -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4">üîç Datenvorschau</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead id="tableHead" class="bg-gray-50">
                            <!-- Headers werden hier eingef√ºgt -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Daten werden hier eingef√ºgt -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let currentData = [];
        let columns = [];
        let numericColumns = [];
        let currentChart = null;
        let chartType = 'bar';

        // Datei-Upload Handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // UI Updates
            document.getElementById('loadingDiv').classList.remove('hidden');
            document.getElementById('successDiv').classList.add('hidden');

            try {
                let data = [];
                
                if (file.name.endsWith('.csv')) {
                    // CSV parsen
                    const text = await file.text();
                    const result = Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        delimitersToGuess: [',', ';', '\t', '|']
                    });
                    data = result.data;
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Excel parsen
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { cellDates: true });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    data = XLSX.utils.sheet_to_json(firstSheet);
                }

                // Daten verarbeiten
                processData(data, file.name);
                
                // UI Updates
                document.getElementById('loadingDiv').classList.add('hidden');
                document.getElementById('successDiv').classList.remove('hidden');
                document.getElementById('fileInfo').textContent = `${file.name} ‚Ä¢ ${data.length} Zeilen ‚Ä¢ ${Object.keys(data[0] || {}).length} Spalten`;
                
                // Dashboard anzeigen
                showDashboard();

            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loadingDiv').classList.add('hidden');
                alert('Fehler beim Laden der Datei: ' + error.message);
            }
        }

        // Daten analysieren und verarbeiten
        function processData(data, fileName) {
            currentData = data.slice(0, 1000); // Limit f√ºr Performance
            
            if (currentData.length === 0) {
                throw new Error('Keine Daten gefunden');
            }

            // Spalten analysieren
            columns = Object.keys(currentData[0]);
            numericColumns = [];

            columns.forEach(col => {
                const values = currentData.slice(0, 50).map(row => row[col]);
                const numericCount = values.filter(v => !isNaN(Number(v)) && v !== null && v !== '').length;
                
                if (numericCount > values.length * 0.7) {
                    numericColumns.push(col);
                }
            });

            console.log('Daten verarbeitet:', {
                zeilen: currentData.length,
                spalten: columns.length,
                numerisch: numericColumns.length
            });
        }

        // Dashboard anzeigen
        function showDashboard() {
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // Statistiken anzeigen
            showStats();
            
            // Dropdown-Men√ºs f√ºllen
            fillSelectOptions();
            
            // Chart-Typ setzen
            setChartType('bar');
            
            // Datenvorschau
            showDataPreview();
            
            // Zum Dashboard scrollen
            document.getElementById('dashboardSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Statistiken anzeigen
        function showStats() {
            const statsHtml = `
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Zeilen</p>
                    <p class="text-2xl font-bold text-blue-600">${currentData.length.toLocaleString()}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Spalten</p>
                    <p class="text-2xl font-bold text-green-600">${columns.length}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Zahlen-Spalten</p>
                    <p class="text-2xl font-bold text-purple-600">${numericColumns.length}</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-600">Chart-Typ</p>
                    <p class="text-2xl font-bold text-orange-600">${chartType.toUpperCase()}</p>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        // Dropdown-Optionen f√ºllen
        function fillSelectOptions() {
            const xSelect = document.getElementById('xAxisSelect');
            const ySelect = document.getElementById('yAxisSelect');
            
            // X-Achse: Alle Spalten
            xSelect.innerHTML = columns.map(col => 
                `<option value="${col}">${col}</option>`
            ).join('');
            
            // Y-Achse: Nur numerische Spalten (fallback: alle)
            const yOptions = numericColumns.length > 0 ? numericColumns : columns;
            ySelect.innerHTML = yOptions.map(col => 
                `<option value="${col}">${col}</option>`
            ).join('');

            // Standard-Auswahl
            if (numericColumns.length > 0) {
                ySelect.value = numericColumns[0];
            }
        }

        // Chart-Typ setzen
        function setChartType(type) {
            chartType = type;
            
            // Button-Styles updaten
            ['btnBar', 'btnLine', 'btnPie'].forEach(id => {
                document.getElementById(id).className = 'btn-secondary flex items-center justify-center p-3';
            });
            document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).className = 'bg-blue-600 text-white flex items-center justify-center p-3 rounded-md';
            
            // Stats updaten
            showStats();
            
            // Chart updaten
            updateChart();
        }

        // Chart erstellen/updaten
        function updateChart() {
            const xCol = document.getElementById('xAxisSelect').value;
            const yCol = document.getElementById('yAxisSelect').value;
            
            if (!xCol || !yCol) return;

            // Daten aggregieren
            const aggregatedData = aggregateData(xCol, yCol);
            
            // Chart-Title updaten
            document.getElementById('chartTitle').textContent = `üìà ${yCol} nach ${xCol}`;
            document.getElementById('dataPointsCount').textContent = `${aggregatedData.length} Datenpunkte`;

            // Alten Chart zerst√∂ren
            if (currentChart) {
                currentChart.destroy();
            }

            // Neuen Chart erstellen
            const ctx = document.getElementById('myChart').getContext('2d');
            
            const chartConfig = {
                type: chartType === 'pie' ? 'pie' : chartType === 'line' ? 'line' : 'bar',
                data: {
                    labels: aggregatedData.map(item => String(item.label).slice(0, 20)),
                    datasets: [{
                        label: yCol,
                        data: aggregatedData.map(item => item.value),
                        backgroundColor: chartType === 'pie' ? 
                            ['#8884d8', '#82ca9d', '#ffc658', '#ff7300', '#00ff00', '#ff00ff', '#00ffff', '#ff0000'] :
                            'rgba(136, 132, 216, 0.8)',
                        borderColor: 'rgba(136, 132, 216, 1)',
                        borderWidth: 2,
                        fill: chartType === 'line' ? false : true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie',
                            position: 'right'
                        }
                    },
                    scales: chartType === 'pie' ? {} : {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yCol
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: xCol
                            }
                        }
                    }
                }
            };

            currentChart = new Chart(ctx, chartConfig);
        }

        // Daten aggregieren
        function aggregateData(xCol, yCol) {
            const grouped = {};
            
            currentData.forEach(row => {
                const key = String(row[xCol] || 'Leer');
                if (!grouped[key]) {
                    grouped[key] = { label: key, value: 0, count: 0 };
                }
                grouped[key].value += Number(row[yCol]) || 0;
                grouped[key].count += 1;
            });

            // Top 15 f√ºr bessere Performance
            return Object.values(grouped)
                .sort((a, b) => b.value - a.value)
                .slice(0, 15);
        }

        // Datenvorschau anzeigen
        function showDataPreview() {
            const maxCols = Math.min(columns.length, 6);
            const maxRows = Math.min(currentData.length, 5);
            
            // Header
            const headerHtml = columns.slice(0, maxCols).map(col => 
                `<th class="px-4 py-3 text-left font-medium text-gray-600 border-b">${col}</th>`
            ).join('');
            document.getElementById('tableHead').innerHTML = `<tr>${headerHtml}</tr>`;
            
            // Rows
            const rowsHtml = currentData.slice(0, maxRows).map(row => {
                const cellsHtml = columns.slice(0, maxCols).map(col => {
                    const value = String(row[col] || '').slice(0, 50);
                    return `<td class="px-4 py-3 text-gray-800 border-b">${value}</td>`;
                }).join('');
                return `<tr class="hover:bg-gray-50">${cellsHtml}</tr>`;
            }).join('');
            document.getElementById('tableBody').innerHTML = rowsHtml;
        }

        // App zur√ºcksetzen
        function resetApp() {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('successDiv').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            currentData = [];
            columns = [];
            numericColumns = [];
            
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Drag & Drop Support
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('bg-blue-50');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('bg-blue-50');
            }

            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // Erfolgs-Meldung nach 3 Sekunden
        setTimeout(() => {
            console.log('‚úÖ Dashboard Generator geladen und bereit!');
        }, 1000);
    </script>
</body>
</html>
